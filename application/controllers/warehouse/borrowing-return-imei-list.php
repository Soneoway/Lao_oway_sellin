<?php
$sort           = $this->getRequest()->getParam('sort');
$desc           = $this->getRequest()->getParam('desc', 0);
$page           = $this->getRequest()->getParam('page', 1);

$rq = $this->getRequest()->getParam('rq');

$co = $this->getRequest()->getParam('co');

$co_munti = $this->getRequest()->getParam('co_munti');
$co_munti = array_values(array_unique($co_munti));

$code = $this->getRequest()->getParam('code');
$fullname = $this->getRequest()->getParam('fullname');
$position = $this->getRequest()->getParam('position');

$rm_fullname = $this->getRequest()->getParam('rm_fullname');
$mg_fullname = $this->getRequest()->getParam('mg_fullname');

$created_at_to = $this->getRequest()->getParam('created_at_to');
$created_at_from = $this->getRequest()->getParam('created_at_from');

$return_at_to  = $this->getRequest()->getParam('return_at_to');
$return_at_from = $this->getRequest()->getParam('return_at_from');

$grade = $this->getRequest()->getParam('grade');
// $type = $this->getRequest()->getParam('type');

$hrs_department_id = $this->getRequest()->getParam('hrs_department_id');

$status_return = $this->getRequest()->getParam('status_return',1);
$imei = $this->getRequest()->getParam('imei');

$imei_munti          = $this->getRequest()->getParam('imei_munti');
$imei_munti          = array_values(array_unique($imei_munti));

$export = $this->getRequest()->getParam('export',0);

$limit = LIMITATION;
$total = 0;

if($imei_munti || $rq || $co){
    $limit = 300;
}

if($imei == 'fix_imei_return_800_pui'){

    $imei = null;

    $imei_munti = ['862641039961311','862641039935117','862641039930290','862641039963010','862641039929755','864717032129516','862641039964414','862641039961477','864717032129938','862641039964653','862641039935612','864717032130373','862641039930696','862641039930795','864717032126819','862641039924434','862641039961659','864717032130258','864717032127031','862641039929714','862641039962970','862641039963937','862641039939952','862641039930456','864717032130290','862641039935034','862641039963119','862641039931033','862641039913635','862641039925779','862641039960875','862641039935539','862641039931132','864717032129532','864717032130274','862641039961071','862641039929136','862641039925738','862641039925654','862641039962632','862641039962897','862641039939770','862641039927676','862641039964133','862641039936875','862641039929052','862641039926116','864717032129979','862641039926751','862641039935158','862641039930357','864717032130399','862641039927130','862641039961212','862641039923857','862641039930316','862641039924939','862641039935430','862641039929938','862641039936057','862641039929870','862641039964539','864717032130415','862641039912835','862641039935711','862641039962871','862641039929037','862641039935836','862641039962731','862641039931298','862641039931116','862641039926678','862641039962715','862641039962590','862641039929417','864717032130332','862641039932098','862641039961154','862641039927650','862641039927833','862641039929078','862641039929516','862641039963812','862641039929656','862641039961055','864717032127890','864717032126835','864717032129292','862641039939911','862641039962335','862641039929334','862641039925753','864717032130654','864717032130670','864717032130738','862641039961691','862641039932213','862641039962699','862641039931215','862641039965171','862641039940059','862641039931710','862641039931058','862641039939531','862641039923956','862641039924798','862641039936917','862641039935679','862641039932031','862641039962178','864717032130217','862641039935935','862641039962293','862641039929532','862641039939796','862641039960834','862641039928898','862641039844491','864717032117479','862641039850035','864717039243096','862641039844475','864717032121950','864717032115655','864717032115556','864717032119772','864717032116018','862641039851215','864717032091393','862641039849391','862641039852452','862641039840192','862641039849334','862641039852858','864717032095113','864717032119418','864717032094819','864717032092516','862641039844913','864717039245059','862641039843873','864717032115432','862641039846132','864717032117016','864717032092714','862641039843675','864717032092573','862641039847999','864717032116950','862641039845910','864717032094470','862641039851413','864717039244235','862641039842214','862641039865538','864717039240019','864717032115812','862641039850316','864717032115291','862641039870355','864717032095790','862641039854094','862641039844293','862641039865272','862641039863632','864717032091997','862641039842917','862641039864952','864717039244334','864717032120374','864717032097275','864717032095493','864717032097176','862641039850993','862641039849474','864717032118055','862641039865017','864717032117370','864717032122354','862641039865074','862641039851355','862641039848955','864717032118493','864717032116836','864717032118410','862641039863756','862641039863558','862641039870397','864717032117776','864717032121752','862641039853997','862641039854656','862641039854151','864717032115135','862641039847353','864717032119111','864717032092532','864717032116471','864717032116257','862641039850811','862641039850639','862641039845738','864717032115895','862641039852031','864717032098034','862641039870751','862641039841471','862641039850274','862641039841935','864717032097457','862641039845837','864717032098091','864717032096798','864717032116778','864717032097135','862641039842339','862641039852718','864717032115739','864717032117255','862641039870892','864717032116992','864717032120879','864717032098059','864717032097572','862641039845936','864717032120713','864717032116596','862641039847437','862641039851256','864717032097358','864717032092078','864717032097655','864717032116851','864717032115374','864717032117115','862641039842396','862641039870033','864717032116638','864717032117453','864717032095576','862641039865330','862641039850530','864717032121190','862641039850472','864717032095410','864717032094934','864717032120416','862641039865454','862641039841679','864717032119913','862641039845050','864717032092094','864717032090759','862641039851934','862641039851876','864717032122073','862641039852791','864717032114898','862641039864713','862641039852197','864717032090791','862641039841513','862641039844335','862641039841976','864717032121356','862641039871437','864717032117313','862641039844871','864717032092193','864717039244490','862641039848872','864717032119053','862641039864614','862641039850738','864717032099438','862641039848971','864717032121570','862641039847510','864717032116695','864717039244938','864717032099578','862641039850076','864717032121174','862641039845258','864717032097234','864717032092037','864717032120796','862641039844095','864717039243799','862641039870439','862641039863715','864717032094298','862641039845894','864717039243575','864717032121810','862641039850134','864717032098570','862641039846017','864717032097473','864717039240217','862641039854078','862641039848799','864717032115192','862641039846975','864717032092433','864717032118212','862641039852015','864717032120358','862641039841810','864717032091377','862641039848898','862641039865611','864717032115234','862641039852551','862641039849052','862641039843410','862641039870934','864717032120978','864717032094033','862641039871197','864717032116539','862641039854193','864717032120259','862641039967276','862641039974595','862641039964919','862641039970072','862641039970155','862641039971534','862641039970015','862641039970031','864717037825837','864717037826553','864717033538954','864717033541974','864717032133757','864717037826157','864717037829839','862641039971575','864717039506872','864717039292473','864717039506138','864717039294396','864717038457952','864717038458950','864717032098158','864717033387550','864717033388533','864717038459099','864717038458034','864717039294198','864717032095915','864717032093191','864717032096053','864717032096095','864717032095238','864717032092755','864717032093357','864717032096178','864717039292994','863966034519817','863966034519098','863966034737450','863966034736296','863966034475838','863966034510873','863966034439891','863966034724938','863966034477891','863966034726156','863966034725059','863966034440071','863966034431799','863966034431831','863966034474690','863966034472793','863966034434652','863966034509156','863966034477859','863966034724276','863966034738813','863966034521896','863966034477412','863966034478238','863966034517472','863966034512655','863966034496677','865257038717310','863966034519031','863966034519759','863966034474997','863966034477479','863966034742914','863966034519775','863966034434173','863966034737054','863966034442937','863966034730992','865257038770939','863966034440451','863966034522951','863966034439354','863966034474096','863966034497071','863966034519395','863966034736510','863966034741734','863966034479715','863966034472314','863966034735736','863966034518934','863966034522332','863966034519692','863966034518975','865257038716213','863966034731339','863966034431351','863966034519791','863966034728996','863966034518991','863966034512770','863966034519999','863966034477313','863966034478717','863966034522134','863966034519296','863966034740892','863966034496735','863966034434132','863966034512713','863966034522258','863966034443034','863966034498178','863966034474492','863966034521359','863966034460616','863966034432474','863966034431815','863966034737252','863966034518017','863966034431393','863966034522894','863966034736239','863966034518637','863966034476430','863966034477396','863966034431930','863966034519056','863966034743110','863966034735215','863966034478394','863966034433878','863966034434017','863966034511616','863966034445856','863966034742930','863966034477495','863966034478170','863966034516359','863966034519593','863966034432235','863966034496032','863966034737732','863966034735116','863966034523199','863966034510212','863966034519734','863966034732436','863966034516292','863966034443059','863966034440097','863966034725679','863966034496016','863966034519858','863966034471712','863966034736411','863966034737658','863966034523132','863966034734036','863966034433555','863966034434058','863966034511939','863966034479376','863966034442697','863966034517779','863966034468692','863966034520054','865257038561312','863966034737617','863966034733673','863966034518876','863966034724474','863966034736270','863966034736155','863966034520138','863966034475119','863966034478196','863966034443075','863966034520096','863966034431674','863966034479111','863966034431310','863966034431237','863966034440212','863966034725695','863966034520195','863966034472959','863966034523314','863966034511236','863966034731792','863966034439594','863966034440592','863966034741239','863966034516870','863966034519254','863966034442838','863966034472330','865257038770798','863966034519510','863966034737070','863966034732758','863966034477099','863966034737336','863966034737575','863966034733871','863966034518173','863966034728418','863966034496859','865257038767877','863966034731974','863966034521797','863966034730570','863966034440832','863966034440113','865257038770756','863966034498756','863966034461556','865257038716759','863966034519155','863966034446151','863966034460731','863966034511178','863966034511012','863966034479350','863966034730612','863966034477214','863966034732097','865257037506276','863966034510592','863966034511079','865257038770814','863966034512192','863966034474393','863966034474419','863966034725711','863966034431732','863966034473296','863966034721553','863966034460954','863966034431336','863966034514677','863966034741072','863966034431377','863966034519197','863966034733954','863966034435295','863966034518959','863966034519452','865257034413138','865257034415059','865257037761038','865257038400677','865257034409672','865257037760592','865257038402111','865257038400974','865257034409896','865257037757234','865257037762531','865257034410217','865257034413435','865257038401899','865257038401733','865257034410571','865257034410290','865257034409573','865257034410175','865257034413716','865257034412932','865257038402095','865257034413559','865257034410951','865257034410050','865257037383916','865257034409979','865257037387438','865257034409730','865257037384138','865523032259579','865523032262870','865523032262136','865523032261278','865523032257276','865523032261831','865523032261195','865523032262474','865523032257292','865523032261815','865523032264736','865523032265170','865523032265014','865523032264637','865523032264173','865523032264579','865523032264058','865523032264199','865523032264892','865523032264298','865523032265659','865523032266913','865523032267077','865523032266855','865523032266533','865523032267010','865523032266673','865523032267051','865523032265691','865523032266699','865523032270832','865523032270519','865523032270592','865523032270857','865523032269933','865523032270139','865523032267812','865523032270972','865523032269354','865523032270899','865523032267911','865523032267473','865523032267770','865523032267390','865523032267754','865523032267291','865523032266954','865523032267978','865523032267259','865523032269396','865523032258472','865523032260213','865523032258274','865523032256914','865523032260130','865523032259959','865523032259918','865523032260239','865523032258118','865523032260015','865523032261492','865523032261591','865523032263076','865523032263431','865523032262813','865523032261633','865523032261690','865523032263290','865523032261716','865523032261575','865523032268570','865523032267994','865523032267671','865523032268836','865523032269370','865523032268596','865523032271558','865523032269834','865523032271673','865523032269032','865523032260478','865523032257375','865523032258050','865523032259793','865523032260379','865523032259710','865523032260270','865523032259850','865523032259991','865523032259975','865523032269735','865523032272838','865523032271632','865523032271970','865523032272671','865523032272879','865523032271731','865523032269578','865523032271491','865523032268711','865523032261435','865523032261294','865523032261476','865523032262490','865523032262318','865523032261757','865523032262375','865523032261799','865523032257110','865523032262532','865523032255254','865523032256054','865523032256070','865523032256096','865523032255775','865523032255536','865523032255874','865523032256179','865523032256351','865523032255916','865523032260858','865523032262151','865523032262755','865523032260759','865523032262698','865523032262573','865523032262730','865523032259090','865523032262276','865523032260593','865523032265592','865523032268273','865523032265915','865523032267119','865523032266392','865523032268158','865523032266293','865523032266756','865523032268091','865523032267598','865523032266558','865523032266038','865523032264090','865523032266152','865523032266517','865523032265550','865523032266459','865523032266970','865523032266095','865523032265931','865523032271194','865523032432234','865523032432754','865523032433653','865523032432655','865523032433612','865523032432515','865523032432150','865523032266335','865523032266277','865523032435070','865523032433877','865523032434537','865523032434750','865523032433810','865523032434818','865523032433794','865523032434693','865523032434792','865523032433851','865523032260254','865523032261039','865523032267358','865523032269495','865523032267416','865523032269594','865523032267374','865523032265733','865523032269511','865523032267457','865523032267556','865523032265857','865523032265477','865523032490778','865523032265295','865523032265196','865523032490877','865523032266236','865523032488673','865523032759834','865523032275153','865523032267218','865523032260551','865523032261336','865523032490513','865523032490174','865523032490810','865523032490216','865523032490893','865523032261351','865523032265055','865523032266079','865523032266053','865523032490315','865523032261310','863596038193515'];
    $imei_munti = array_values(array_unique($imei_munti));

    $limit = 1000;
}

$params = array_filter( array(
    'rq'               => $rq,
    'co'               => $co,
    'co_munti'         => $co_munti,
    'code'             => $code,
    'fullname'         => $fullname,
    'position'         => $position,
    'rm_fullname'      => $rm_fullname,
    'mg_fullname'      => $mg_fullname,
    'created_at_to'    => $created_at_to,
    'created_at_from'  => $created_at_from,
    'return_at_to'     => $return_at_to,
    'return_at_from'   => $return_at_from,
    'grade'            => $grade,
    // 'type'             => $type
    'hrs_department_id'=> $hrs_department_id,
    'status_return'    => $status_return,
    'imei'             => $imei,
    'imei_munti'       => $imei_munti
));

$params['sort'] = $sort;
$params['desc'] = $desc;

$QBL = new Application_Model_BorrowingList();

if (isset($export) and $export){

    $data = $QBL->fetchPagination_return_imei($page, null, $total, $params);
    $this->exportBorrowingReturnImei($data);
    
}else{
    $data = $QBL->fetchPagination_return_imei($page, $limit, $total, $params);
}

// print_r($data);die;

$db = Zend_Registry::get('db');
$select = $db->select()->from(array('p' => 'oppohr.department'),array('p.id','p.name'))->order('p.name');
$department = $db->fetchAll($select);

$this->view->department   = $department;

$this->view->data   = $data;

$this->view->desc   = $desc;
$this->view->sort   = $sort;
$this->view->params = $params;
$this->view->limit  = $limit;
$this->view->total  = $total;
$this->view->url    = HOST.'warehouse/borrowing-return-imei-list/'.( $params ? '?'.http_build_query($params).'&' : '?' );
$this->view->warehouses = $warehouses;
$this->view->distributors = $distributors;
$this->view->offset = $limit*($page-1);

$flashMessenger = $this->_helper->flashMessenger;
$messages = $flashMessenger->setNamespace('error')->getMessages();
$this->view->messages = $messages;

$messages_success = $flashMessenger->setNamespace('success')->getMessages();
$this->view->messages_success = $messages_success;