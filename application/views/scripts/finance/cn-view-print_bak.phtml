


<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Print</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <style type="text/css">
       @page{
        size: auto A4;
        margin: 5mm;
     }

      body{width: 323mm; height: 377mm;font-size:16px;font-family:Tahoma;}
      .top_page{margin-top: 67px;}
      .top{text-align:left;}
      .hid{visibility:hidden;}
      .top p{height:24px;line-height:24px;margin:0}
      .textbox{width:600px;border:1px solid black;height:70px}
      .blank10{height:10px;clear:both}

      .title_page_logo {font-weight:bold;}
      .title_page_logo_small{font-weight: normal;}
      .title_page{width: auto;text-align:center;font-size:15px;font-weight:bold;margin-top: 5px}
      .title_page_small_left{width: auto;text-align:left;height:12px;font-size:12px;line-height:12px;float:left;}
      .title_page_small_right{width: auto;text-align:right;height:12px;font-size:12px;line-height:12px;float:right;margin-top: -10px;}
      .title{width:600px;text-align:center;height:30px;font-size:15px;line-height:30px;background-color:#fabf8f;font-weight:bold}
      .title small {float: right;font-weight: normal;font-size: 8px;padding-right: 2em;}
      .tbl,
      .tbllist{width:90%;margin-top: 5px;}
      .tbllist_imei{margin-top: 30px;}
      .tbllist_height{height: 30mm;}
      .tbl_col1_list{width:150px;padding: 5px;margin-left: 50px;}
      .tbl_col2_list{width:410px;padding: 5px;}
      .tbl_col3_list{width:30px;margin-left: 50px;text-align: left;padding: 5px;}
      .tbl_col4_list{width:80px;margin-left: 0px;text-align: right;padding: 5px;}
      .tbl_col5_list{width:120px;margin-left: 0px;text-align: right;padding: 5px;}
      .tbl_col6_list{width:100px;margin-left: 0px;text-align: right;padding: 5px;}
      .tbl_col7_list{width:100px;margin-left: 0px;text-align: right;padding: 5px;}
      .tbl_col8_list{width:100px;margin-left: 0px;text-align: right;padding: 5px;}
      .tbl_col9_list{width:120px;margin-left: 0px;text-align: right;padding: 5px;}

      .tbl_col1_list_sum{width:230px;}
      .tbl_col2_list_sum{width:350px;}
      .tbl_tr_list_sum{margin-left: 410px;margin-top: -15px;position: absolute;width:750px;height: 30px;}
      .tbl_col3_list_sum{margin-left: 5px;text-align: center;position: absolute;}
      .tbl_col4_list_sum{margin-left: -50px;text-align: right;position: absolute;}
      .tbl_col5_list_sum{margin-left: 210px;text-align: right;position: absolute;}
      .tbl_col6_list_sum{margin-left: 330px;text-align: right;position: absolute;}
      .tbl_col7_list_sum{margin-left: 410px;text-align: right;position: absolute;}
      .tbl_col8_list_sum{margin-left: 520px;text-align: right;position: absolute;}
      .tbl_col9_list_sum{margin-left: 610px;text-align: right;position: absolute;}
      .single_record{page-break-after: always;}
      .tbl tr{margin:0}
      .tbl tr td,
      .tbllist tr td{background-color:#fff}.tbl .firsttd{width:145px}.tbl .secondtd{width:100px}.tbl .thirdtd{width:36px}.tbl .forthtd{width:65px}
      

         .note{border-bottom:1px dotted #ccc;width:300px;float:left;margin:9px 0 0 25px}.green{text-align:center}.green td{background-color:#ccffcc!important}#logo{
	float:left;
	display:block;
	left: 261px;
	top: 71px;
}#logo img{width:136px;margin-top:10px}
.trcenter{text-align:center}
.invoice{width:453px;display:block;clear:both;margin-left:119px}
.invoice-number{float:left;padding-left:37px}
.order-type{float:right;text-align:right}
         .right{text-align:right}
         .detail{width:842px}
         .title_page_col_left{float:left;width: 300px; }
         .title_page_col_right{float:right;width: 850px;}

         .below_page_col_left{float:left;width: 100px;}
         .below_page_col_right{float:right;width: 200px;margin-left: -300px;}
         .below_page_col_right_1{float:right;width: 400px;margin-left: -200px;}
         
         .below_detail .col1 span{width:300px;float:left;font-weight:bold;}
         .below_detail .col2 span{width:309px;float:left;font-weight:normal;}

         
         .below_detail_left{width:309px;float:left;font-weight:normal;}

         .assign{width: 200px;font-weight: bold;float: left;
         
         /* margin-top: 10px; */
         border-top: 1px dotted black;
         margin-left: 0px;
         margin-top: 40px;
         text-align: center;
         padding-top: 10px;}

         .signature_page_col_right{float:right;}

         .detail .col1{width:109px;float:left}
         .detail .col1 span{width:109px;float:left;font-weight:bold}
         .detail .col2{width:224px;float:left}
         .detail .col2_title{width:600px;float:left}
         .detail .col2 span{font-weight:bold}
         .detail .col3{width:100px;float:left}
         .detail .col3 span{font-weight:bold}
         .clear{clear:both}
         .colleft{float:left;width:300px}
         .colright{float:right;width:165px}
         .tablelist {font-size:10px;}
        

         .vat{width:435px!important;float:right!important}#vatnumber{clear:both}#vatnumber .sn{width:54px;border:1px solid black;height:14px;float:left}.marksn{float:left;border-left:1px solid black;font-weight:bold;padding-left:3px}.order{float:left;margin-left:10px}.order .sn{width:5px;height:10px;border:1px solid black;float:left;margin-left:5px}.order .alert{margin-left:16px;margin-bottom:4px}
         
        input[type="text"]
        {
            display: block;
            margin: 0px;
            font-family: time new roman;
            font-weight: bold;
            text-align: center;
            font-size: 10px;
            border: none;
        }
        .model
        {font-size: 8px !important;
            text-transform:uppercase;
        }
        .imgbutton{width:40px !important;cursor:pointer;position:  absolute;}
        @media print{.print,.no-print{display:none!important}
        .page-break  { display: block; page-break-before: always; }
        }
        .print{width:20px !important;.print,.no-print{display:none!important}}
        .scroll{overflow:hidden;}
        .number{width:10px;}
        .signname{  width: 549px;            margin: auto;            padding-left: 70px;}
    </style>

    <script type="text/javascript">
        function Print()
        {
            //$( ".imgbutton" ).remove();
            window.print();
        }

    </script>
        <?php

        function decimal_remove_comma($priceFloat)
{
    $price = str_replace(",","",$priceFloat);;
    return $price;
}

function product_price($priceFloat) {
    $symbol = ' THB';
    $symbol_thousand = ',';
    $decimal_place = 2;
    $price = number_format($priceFloat, $decimal_place, '.', $symbol_thousand);
    return $price;
}

function cal_sale_off_percent($sale_off_percent,$price,$num,$price_total){

    //$sale_off =(100-$percent_sale_off)*0.01;
    //$price_sale_off=($price*$sale_off);
    if($sale_off_percent>0){
        //$price_sale_off=$price_total/$num;
        $price_sale_off = $price - (($price*$sale_off_percent/100)*100)/100;

    }else{
        $price_sale_off = $price;
    }
    return $price_sale_off;
}

function product_price_full($priceFloat) {
    $symbol = ' THB';
    $symbol_thousand = ',';
    $decimal_place = 2;
    $price = number_format($priceFloat, $decimal_place, '.', $symbol_thousand);
    return $price;
}

function format_number_4($num){
    //$a = 5678.56789;
    //$res = substr($num,0,strpos($num,'.')+3); 
    //return decimal_remove_comma($res);
   return decimal_remove_comma(number_format($num, 4));
}

function format_number_2($num){
   return decimal_remove_comma(number_format($num, 2));
}

function ext_vat($num){
   return $num/1.07;
}

            $item=$this->sales;
            //print_r($item);
            $item_total=count($item);
            $item_per_page=13;
            $item_imei_per_page=7;
            $max_show_imei=50;

            $row_product=0;$row_product_imei=0;
           // $pg_total= round($item_total/$item_per_page);

            if(($item_total%$item_per_page)<=2){
                $pg_total= round($item_total/$item_per_page);
            }else{
                $pg_total= ceil($item_total/$item_per_page);
            }

            if($pg_total<=0){
              $pg_total=1;
            }


            $total_num = $total_price = $total_total = 0;$g_total_num=0;
            $g_correct_amount=0;$g_difference_amount=0;
            $g_total_balance=0;$g_total_VAT=0;$g_total_amount=0;

            $correct_bal_amount=0;$difference_amount=0;
            $g_total_price=0;$g_correct_bal_amount=0;

           // $item=$this->sales;
            //print_r($item);
           // $item_total=count($item);
          //  $item_per_page=12;
            

            $retailer_name="";$prepared_by_name="";
            //print_r($this->sales[0]);
            $retailer_name= $this->sales[0]['unames'];
           // $prepared_by_name= $this->sales[0]['prepared_by'];

            $add_tax = $this->sales[0]['add'];
            $distributor_tax = $this->sales[0]['mst_sn'];
            $cn_no= $this->sales[0]['creditnote_sn_view'];
            $create_date=$this->sales[0]['create_date_cn_view'];
            $create_date= date("d-m-Y", strtotime($create_date));
            
            $parent=$this->sales[0]['parent'];
            if($parent==0){
                $branch_name='สำนักงานใหญ่';
                $branch_no=$this->sales[0]['branch_no'];

            }else{
                $branch_name='สาขา';
                $branch_no=$this->sales[0]['branch_no'];
            }

        ?>
</head>
<body>
<?php
  $top_page=67;$row_product=0;
  for($pg=1;$pg<=$pg_total;$pg++)
  {
    if($pg==1){
        $top_page=67;
    }else{
      $top_page+=6;
    }  

    $pg_number= $pg."/".$pg_total; 
?>
    <div class="top_page" ></div>
    <div id="logo" class="hid">
        <?php if ($this->market['warehouse_id'] != 8){?>
        <img src="<?php echo HOST ?>img/logoprint.png" />
        <br />
        <?php } ?>
        
    </div>

    <br>

    <div class="top ">
        <div style="float:right;margin-right: 150px" ><?php echo $pg_number;?></div>
        <div class="title_page_logo hid">บริษัท ไทย ออปโป้ จำกัด</div>
        <div class="title_page_logo hid">THAI OPPO CO., LTD</div></br>
        <div class="title_page_logo_small hid">สำนักงานใหญ่:  อาคาร เอไอเอ แคปปิตอล เซ็นเตอร์ ชั้น 31 ห้อง 5-7 เลขที่ 89 ถนนรัชดาภิเษก แขวงดินแดง เขตดินแดง กรุงเทพฯ 10400 โทร.02-013-1810 โทรสาร 02-013-1820</div>
        <div class="title_page_logo_small hid">Head Office: AIA Capital Center Building Fl 31 Unit 5-7  89 Ratchadaphisek Road, DinDaeng, DinDaeng, Bangkok 10400 Tel.02-013-1810 Fax: 02-013-1820</div>
    </div>
    <div class="title_page hid">ต้นฉบับใบลดหนี้/ใบกำกับภาษี/ใบรับคืนสินค้า</div>
    <div class="title_page_small_left hid">เลขประจำตัวผู้เสียภาษี : <?=$distributor_tax?></div></br>
    <div class="title_page_small_right hid">(เอกสารออกเป็นชุด)</div></br>
    <div class="title_page_col_left">
        <div class="detail clear">
            <div class="col1 hid"><span>วันที่</span></div>  <div class="col2"><?=$create_date;?></div></br>
            <div class="col1 hid"><span>เลขที่ใบลดหนี้</span></div>  <div class="col2"><?=$cn_no?></div></br>
            <div class="col1 hid"><span>ชื่อสาขา</span></div>  <div class="col2"><?=$branch_name?></div></br>
            <div class="col1 hid"><span>สาขาที่</span></div>  <div class="col2"><?=$branch_no?></div></br>
        </div>
    </div>
    <div class="title_page_col_right">
        <div class="detail clear">
            <div class="col1 hid"><span>ชื่อลูกค้า</span></div>  <div class="col2_title"><?= $retailer_name?></div></br>
            <div class="col1 hid"><span>ที่อยู่</span></div>  
            <div class="col2_title"><?=$add_tax?></br> 
            เลขประจำตัวผู้เสียภาษี : <?=$distributor_tax?>
        </div>
        </div>
    </div>
    </br>
    <div class="blank10"></div>

<div class="blank10"></div>
<table class="tbllist" cellspacing="0" cellpadding="11">
    <tr class="tbllist_height hid">
        <td class="tbl_col1_list" >เล่มที่/เลขที่ใบกำกับภาษีเดิม</br>Invoice number</td>
        <td class="tbl_col2_list" >รายการ</br>Description</td>
        <td class="tbl_col3_list" >จำนวน</br>Quantity</td>
        <td class="tbl_col4_list" >หน่วยละ</br>Unit Price</td>
        <td class="tbl_col5_list" >มูลค่าสินค้าหรือบริการตามใบกำกับภาษีเดิม</br>Amount according to previous tax invoice</td>
        <td class="tbl_col6_list" >มูลค่าสินค้าหรือบริการที่ถูกต้อง</br>The correct balance</td>
        <td class="tbl_col7_list" >ผลต่างลดหนี้</br>Difference amount</td>
        <td class="tbl_col8_list" >จำนวนภาษีมูลค่าเพิ่ม</br>VAT</td>
        <td class="tbl_col9_list" >จำนวนรวม (บาท)</br>Total (Baht)</td>
    </tr> 
    <?php

        //print_r($this->invoice_list);
        //echo count($this->invoice_list);

        $creditnote_type = substr($cn_no,0,2);
        $remark='';$margin_sum=5;$margin_imei=40;
        for($i=0;$i<=$item_per_page;$i++):

            //print_r($item[$i]);
            $total_num = $item[$row_product]['num'];
            $chanel = $item[$row_product]['chanel'];
            
            if($creditnote_type=='CP'){

                $invoice_price = $item[$row_product]['invoice_price'];
                $total_price = $item[$row_product]['total_price'];
                $price = $item[$row_product]['price'];
                if($total_price==$price){
                    $price_unit = $item[$row_product]['invoice_price']/1.07;
                }else{
                    $price_unit = ($invoice_price - ($total_price-$price))/1.07;
                }
                
                $price = $item[$row_product]['price']/1.07;
                $total_price = $price_unit * $total_num;
                $correct_bal_amount= $total_price-(($price)*$total_num);

                //$price_unit = $price_unit+$price;
            }else{
                if($chanel=='reward'){
                    $out_price = $item[$row_product]['out_price']/1.07;
                    $total_price = $price_unit * $total_num;
                    $correct_bal_amount= $total_price-(($price_unit)*$total_num);
                }else{
                    $price_unit = $item[$row_product]['price']/1.07;
                    /*
                    $out_price = $item[$row_product]['out_price'];
                    $sale_off_percent = $item[$row_product]['sale_off_percent'];
                    $price_total = $item[$row_product]['total'];
$price_unit = decimal_remove_comma(product_price(format_number_4(ext_vat(cal_sale_off_percent($sale_off_percent,$out_price,$total_num,$price_total)))));
              */
                    //Staff  50%
                    //$price_unit = 4995.00 /1.07;

                    //Staff  40%
                    //$price_unit = 5994.00 /1.07;

                    $total_price = $price_unit * $total_num;
                    $correct_bal_amount= $total_price-(($price_unit)*$total_num);
                }
            }

            $difference_amount=$total_price-$correct_bal_amount;
            $total_VAT = ($difference_amount*1.07)-$difference_amount;
            $total_amount=$difference_amount+$total_VAT;

            //------------------------//
            $g_total_num +=round($total_num,0);
            $g_total_price +=round($total_price,2);

            $g_correct_bal_amount +=round($correct_bal_amount,2); 
            $g_difference_amount +=round($difference_amount,2);
            $g_total_VAT +=round($total_VAT,2);
            $g_total_amount +=round($total_amount,2);


    ?>
    <?php if($item_total>$row_product){ 
       // print_r($item[$i]);
      //print_r($item[$row_product]);
        $invoice_number=$item[$row_product]['invoice_number'];
        if($invoice_number==''){
            $invoice_number=$item[$row_product]['invoice_number_bvg'];
        }
        
        if($item[$row_product]['text']!='' and $item[$row_product]['text'].'/' != $remark){
            $remark.=$item[$row_product]['text'].'/';
        }
        
    ?>
    <tr>
         <td class="tbl_col1_list"><?php echo $invoice_number;?></td>
         <td class="tbl_col2_list" style="text-align: left;"><?php echo $item[$row_product]['product_detail'];?></td>
         <td class="tbl_col3_list"><?php echo $total_num;?></td>
         <td class="tbl_col4_list"><?php echo My_Number::f($price_unit);?></td>        
         <td class="tbl_col5_list"><?php echo My_Number::f($total_price);?></td>
         <td class="tbl_col6_list"><?php echo My_Number::f($correct_bal_amount);?></td>
         <td class="tbl_col7_list"><?php echo My_Number::f($difference_amount);?></td>
         <td class="tbl_col8_list"><?php echo My_Number::f($total_VAT);?></td>
         <td class="tbl_col9_list"><?php echo My_Number::f($total_amount);?></td>
         
    </tr>
    <?php }else{ 
      $invoice_number = '';
      ?>
    <tr>
         <td class="tbl_col1_list">&nbsp;</td>
         <td class="tbl_col2_list" style="text-align: left;"></td>
         <td class="tbl_col3_list"></td>
         <td class="tbl_col4_list"></td>        
         <td class="tbl_col5_list"></td>
         <td class="tbl_col6_list"></td>
         <td class="tbl_col7_list"></td>
         <td class="tbl_col8_list"></td>
         <td class="tbl_col9_list"></td>
         
    </tr>
    <?php } ?>

    <?php 
        if($invoice_number !=''){
          //$margin_sum +=8;$margin_imei -=8;
        }

      

      /*
      //if($pg==$pg_total  && $item_per_page==$i){
        if($pg ==2){
           $margin_sum =30;$margin_imei =150;
        }else if($pg ==3){
           $margin_sum =80;$margin_imei =150;
        }else if($pg >=4){
           $margin_sum =80;$margin_imei =150;
        
        }else{
           $margin_sum =0;$margin_imei =130; 
           //if($this->distributor_id==4607){
           // $margin_sum =0;$margin_imei =130; 
           //}
        }
    */

      if($pg==$pg_total  && $item_per_page==$i){  

        if($pg >=2){
            $margin_sum =0;$margin_imei =50;
        }else{
            $margin_sum =-20;$margin_imei =30;
        }

        //$margin_sum =-20;$margin_imei =30;


        $class_tr = "style='margin-left: 390px;margin-top: ".$margin_sum."px;position: absolute;width:750px;height: 30px;'"; 

        $tbllist_imei ="style='margin-top: ".$margin_imei."px;'";

        ?>
      <tr <?php echo $class_tr;?>>
         <td class="" colspan="2" style="text-align: left;"></td>
         <td class="tbl_col3_list_sum"><?php echo $g_total_num;?></td>
         <td class="tbl_col4_list_sum"></td>
         <td class="tbl_col5_list_sum"><?php echo My_Number::f($g_total_price);?></td>
         <td class="tbl_col6_list_sum"><?php echo My_Number::f($g_correct_bal_amount);?></td>
         
         <td class="tbl_col7_list_sum"><?php echo My_Number::f($g_difference_amount);?></td>
         <td class="tbl_col8_list_sum"><?php echo My_Number::f($g_total_VAT);?></td>
         <td class="tbl_col9_list_sum"><?php echo My_Number::f($g_total_amount);?></td>
        
    </tr>
    <?php }?>
     
    <?php 
    $row_product+=1;
    endfor;?>
      
</table>
</br>

<table <?php echo $tbllist_imei;?> cellspacing="0" cellpadding="1">
    <tr style="text-align: left;">
        <td class="hid">IMEI code: </td>
    </tr>

    <tr style="text-align: left; height: 200px;vertical-align:top;">
        <td >
                <?php
            $imei_sn_list='';
            $item_list=$this->imei_return_list;$show_item_product='';
            //print_r($item_list);
            //for($i=0;$i<count($item);$i++){
            if($max_show_imei>=count($item_list)){
            for($i=0;$i<=$item_imei_per_page;$i++){
              if($item[$row_product_imei]['cat_id']==11){
                $invoice_number=$item[$row_product_imei]['invoice_number'];
                if($invoice_number==''){
                    $invoice_number=$item[$row_product_imei]['invoice_number_bvg'];
                }

                //$invoice_number= $item[$i]['invoice_number'];
                $product_name= $item[$row_product_imei]['product_detail'];
                $product_detail= $product_name.' [';
                //print_r($item_list);
                $product_detail_imei ='';$imei_list='';$count_item=0;$row_imei=0;$count_row_imei=0;
                for($j=0;$j<count($item_list);$j++){
                    //$show_item_product=$item_list[$j]['product_detail'];
                    $show_item_product = $item_list[$j]['product_detail'];
                    $show_invoice_number=$item_list[$j]['invoice_number'];

                    //echo 'product_name['.$product_name.'] >>show_item_product['.$show_item_product.']</br>';
                   // echo 'invoice_number['.$invoice_number.'] = show_invoice_number['.$show_invoice_number.']</br>';
                    if($product_name==$show_item_product && $invoice_number==$show_invoice_number)
                    {     $count_item+=1;
                           
                        if($row_imei==0){
                          if($count_item==5){
                            $imei_list.=$item_list[$j]['imei_sn'].'</br>,';
                            $count_item=0;
                          }else{
                            $imei_list.=$item_list[$j]['imei_sn'].',';
                          }
                        }else{
                          if($count_item==8){
                            $imei_list.=$item_list[$j]['imei_sn'].'</br>,';
                            $count_item=0;
                          }else{
                            $imei_list.=$item_list[$j]['imei_sn'].',';
                          }
                        }
                        $row_imei+=1;                    
                    }  
                }
                if($g_total_num <=8){
                  echo $product_detail_imei ='['.$invoice_number.']'.$product_detail.rtrim($imei_list,',').']</br>';
                }
            
              }
              
              $row_product_imei+=1;
            }
          }
        ?>
        </td>
    </tr>
</table>


<div id="logo" style="position:  absolute;" >
    <img src="<?php echo HOST ?>img/print.png" class="imgbutton print"  onclick="Print()" id="print"  />
</div>

<?php if($pg==$pg_total){  ?>
</br>
    <div class="below_page_col_left">
        <div class="below_detail clear">
            <div class="col1" style="width: 500px;margin-top: 220px;">
            <?php 
            if($cn_no=='CN590921-00016'){
              $remark='เครื่องเปิดไม่ติด/จอดับเอง /สัญญานไม่คงที่ /เครื่องเปิดไม่ติด/ทัชสกรีนไม่ได้';
              echo $remark;
            }else{
              echo $remark;
            }
             
            $remark='';
            ?>
            </div>
        </div>
    </div>
<?php } ?>
<div class="single_record"></div>    
<?php } ?>

</body>
</html>

